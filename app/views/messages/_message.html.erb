<%
  is_sender = message.sender == current_user
  sender_name = message.sender.full_name
  sender_initials = "#{message.sender.first_name.first}#{message.sender.last_name.first}".upcase
%>

<div id="message_<%= message.id %>" class="flex <%= 'justify-end' if is_sender %> <%= 'justify-start' unless is_sender %>">
  <div class="flex <%= 'flex-row-reverse' if is_sender %> items-end space-x-2 <%= 'space-x-reverse' if is_sender %> max-w-3xl">
    <%# Avatar %>
    <% unless is_sender %>
      <div class="flex-shrink-0 h-8 w-8 rounded-full bg-primary-100 dark:bg-primary-900 flex items-center justify-center mb-1">
        <span class="text-xs font-semibold text-primary-700 dark:text-primary-300">
          <%= sender_initials %>
        </span>
      </div>
    <% end %>

    <%# Message bubble %>
    <div class="flex flex-col <%= 'items-end' if is_sender %>">
      <%# Sender name (only show for other user's messages) %>
      <% unless is_sender %>
        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1 px-3">
          <%= sender_name %>
        </p>
      <% end %>

      <%# Message content %>
      <div class="rounded-lg px-4 py-2 <%= is_sender ? 'bg-primary-600 text-white' : 'bg-white dark:bg-gray-700 text-gray-900 dark:text-white' %> shadow-sm">
        <%# Text content (if present) %>
        <% if message.content.present? %>
          <p class="text-sm whitespace-pre-wrap break-words">
            <%= message.content %>
          </p>
        <% end %>

        <%# Attachment display %>
        <% if message.attachment.attached? %>
          <div class="<%= 'mt-2' if message.content.present? %>">
            <% if message.attachment.blob.content_type.in?(%w[image/jpeg image/jpg image/png image/webp]) %>
              <%# Image attachment - display as clickable preview %>
              <%= link_to download_attachment_conversation_message_path(message.conversation, message),
                    target: "_blank",
                    class: "block rounded-lg overflow-hidden hover:opacity-90 transition-opacity" do %>
                <%= image_tag message.attachment.variant(resize_to_limit: [400, 300]),
                      alt: "Attached image",
                      class: "max-w-full h-auto rounded-lg" %>
              <% end %>
            <% elsif message.attachment.blob.content_type == 'application/pdf' %>
              <%# PDF attachment - display as download link with icon %>
              <%= link_to download_attachment_conversation_message_path(message.conversation, message),
                    target: "_blank",
                    class: "flex items-center space-x-2 p-2 rounded-md #{is_sender ? 'bg-primary-700 hover:bg-primary-800' : 'bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500'} transition-colors" do %>
                <svg class="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                </svg>
                <div class="flex flex-col min-w-0">
                  <span class="text-xs font-medium truncate">
                    <%= message.attachment.filename %>
                  </span>
                  <span class="text-xs opacity-75">
                    <%= number_to_human_size(message.attachment.byte_size) %> â€¢ <%= message.downloads_count %> downloads
                  </span>
                </div>
                <svg class="w-4 h-4 flex-shrink-0 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
              <% end %>
            <% end %>
          </div>
        <% end %>

        <%# Edited indicator %>
        <% if message.edited_at.present? %>
          <p class="text-xs <%= is_sender ? 'text-primary-100' : 'text-gray-500 dark:text-gray-400' %> mt-1 italic">
            (edited <%= time_ago_in_words(message.edited_at) %> ago)
          </p>
        <% end %>
      </div>

      <%# Message metadata (timestamp and read status) %>
      <div class="flex items-center space-x-2 mt-1 px-3">
        <p class="text-xs text-gray-500 dark:text-gray-400">
          <%= message.created_at.strftime("%I:%M %p") %>
        </p>

        <%# Read status (only for sender) %>
        <% if is_sender %>
          <% if message.read? %>
            <svg class="w-4 h-4 text-primary-600 dark:text-primary-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            <span class="text-xs text-gray-500 dark:text-gray-400">Read</span>
          <% else %>
            <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            <span class="text-xs text-gray-400">Sent</span>
          <% end %>
        <% end %>

        <%# Edit/Delete buttons (only for sender and if editable) %>
        <% if is_sender && message.editable? %>
          <%= button_to "Edit",
                edit_conversation_message_path(message.conversation, message),
                method: :get,
                class: "text-xs text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300",
                form: { data: { turbo_frame: "message_#{message.id}" } } %>

          <%= button_to "Delete",
                conversation_message_path(message.conversation, message),
                method: :delete,
                data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this message?" },
                class: "text-xs text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300" %>
        <% end %>
      </div>
    </div>

    <%# Spacer for current user's messages %>
    <% if is_sender %>
      <div class="flex-shrink-0 w-8"></div>
    <% end %>
  </div>
</div>
