<%
  is_sender = message.sender == current_user
  sender_name = message.sender.full_name
  sender_initials = "#{message.sender.first_name.first}#{message.sender.last_name.first}".upcase
%>

<div id="message_<%= message.id %>" class="flex <%= 'justify-end' if is_sender %> <%= 'justify-start' unless is_sender %>">
  <div class="flex <%= 'flex-row-reverse' if is_sender %> items-end space-x-2 <%= 'space-x-reverse' if is_sender %> max-w-3xl">
    <%# Avatar %>
    <% unless is_sender %>
      <div class="flex-shrink-0 h-8 w-8 rounded-full bg-primary-100 dark:bg-primary-900 flex items-center justify-center mb-1">
        <span class="text-xs font-semibold text-primary-700 dark:text-primary-300">
          <%= sender_initials %>
        </span>
      </div>
    <% end %>

    <%# Message bubble %>
    <div class="flex flex-col <%= 'items-end' if is_sender %>">
      <%# Sender name (only show for other user's messages) %>
      <% unless is_sender %>
        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1 px-3">
          <%= sender_name %>
        </p>
      <% end %>

      <%# Message content %>
      <div class="rounded-lg px-4 py-2 <%= is_sender ? 'bg-primary-600 text-white' : 'bg-white dark:bg-gray-700 text-gray-900 dark:text-white' %> shadow-sm">
        <p class="text-sm whitespace-pre-wrap break-words">
          <%= message.content %>
        </p>

        <%# Edited indicator %>
        <% if message.edited_at.present? %>
          <p class="text-xs <%= is_sender ? 'text-primary-100' : 'text-gray-500 dark:text-gray-400' %> mt-1 italic">
            (edited <%= time_ago_in_words(message.edited_at) %> ago)
          </p>
        <% end %>
      </div>

      <%# Message metadata (timestamp and read status) %>
      <div class="flex items-center space-x-2 mt-1 px-3">
        <p class="text-xs text-gray-500 dark:text-gray-400">
          <%= message.created_at.strftime("%I:%M %p") %>
        </p>

        <%# Read status (only for sender) %>
        <% if is_sender %>
          <% if message.read? %>
            <svg class="w-4 h-4 text-primary-600 dark:text-primary-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            <span class="text-xs text-gray-500 dark:text-gray-400">Read</span>
          <% else %>
            <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            <span class="text-xs text-gray-400">Sent</span>
          <% end %>
        <% end %>

        <%# Edit/Delete buttons (only for sender and if editable) %>
        <% if is_sender && message.editable? %>
          <%= button_to "Edit",
                edit_conversation_message_path(message.conversation, message),
                method: :get,
                class: "text-xs text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300",
                form: { data: { turbo_frame: "message_#{message.id}" } } %>

          <%= button_to "Delete",
                conversation_message_path(message.conversation, message),
                method: :delete,
                data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this message?" },
                class: "text-xs text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300" %>
        <% end %>
      </div>
    </div>

    <%# Spacer for current user's messages %>
    <% if is_sender %>
      <div class="flex-shrink-0 w-8"></div>
    <% end %>
  </div>
</div>
