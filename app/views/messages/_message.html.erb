<%
  is_sender = message.sender == current_user
  sender_name = message.sender.full_name
  is_provider = message.sender.provider?
%>

<div id="message_<%= message.id %>"
  class="group flex <%= is_sender ? 'justify-end' : 'justify-start' %>">
  <div class="flex <%= is_sender ? 'flex-row-reverse' : 'flex-row' %> items-end space-x-3 <%= 'space-x-reverse' if is_sender %> max-w-2xl">

    <!-- Avatar (only for received messages) -->
    <% unless is_sender %>
      <div class="shrink-0 mb-1">
        <%= render "shared/user_avatar",
              user: message.sender,
              size: :small,
              shape: :rounded,
              show_ring: true,
              additional_classes: "shadow-lg" %>
      </div>
    <% end %>

    <!-- Message bubble container -->
    <div class="flex flex-col <%= is_sender ? 'items-end' : 'items-start' %> flex-1 min-w-0">

      <!-- Sender name (only for received messages) -->
      <% unless is_sender %>
        <div class="flex items-center space-x-2 mb-1 px-4">
          <p class="text-xs font-semibold text-gray-700">
            <%= sender_name %>
          </p>
          <% if is_provider %>
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-teal-100 text-teal-800">
              Provider
            </span>
          <% end %>
        </div>
      <% end %>

      <!-- Message bubble -->
      <div class="relative group/message">
        <div class="rounded-2xl px-4 py-3 <%= is_sender ? 'bg-teal-600 text-white' : 'bg-white text-gray-900 border border-gray-200' %>">

          <!-- Message content -->
          <% if message.content.present? %>
            <p class="text-sm leading-relaxed whitespace-pre-wrap wrap-break-word">
              <%= message.content %>
            </p>
          <% end %>

          <!-- Attachment display -->
          <% if message.attachment.attached? %>
            <div class="<%= 'mt-3' if message.content.present? %>">
              <% if message.attachment.image? %>
                <!-- Image preview with download overlay -->
                <div class="relative group/image rounded-xl overflow-hidden">
                  <%= image_tag message.attachment.variant(resize_to_limit: [400, 400]),
                      class: "rounded-xl max-w-full h-auto shadow-md",
                      alt: "Attached image" %>
                  <%= link_to download_attachment_conversation_message_path(message.conversation, message),
                      class: "absolute inset-0 flex items-center justify-center bg-black/60 opacity-0 group-hover/image:opacity-100 transition-opacity duration-200" do %>
                    <div class="flex flex-col items-center text-white">
                      <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                      </svg>
                      <span class="text-sm font-medium">Download</span>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <!-- PDF or other file download link -->
                <%= link_to download_attachment_conversation_message_path(message.conversation, message),
                    class: "flex items-center space-x-3 p-3 rounded-xl #{is_sender ? 'bg-white/10 hover:bg-white/20' : 'bg-gray-50 hover:bg-gray-100'} transition-colors duration-200" do %>
                  <div class="shrink-0 h-10 w-10 rounded-lg #{is_sender ? 'bg-white/20' : 'bg-teal-100'} flex items-center justify-center">
                    <svg class="w-5 h-5 #{is_sender ? 'text-white' : 'text-teal-600'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium #{is_sender ? 'text-white' : 'text-gray-900'} truncate">
                      <%= message.attachment.filename %>
                    </p>
                    <p class="text-xs #{is_sender ? 'text-teal-100' : 'text-gray-500'}">
                      <%= number_to_human_size(message.attachment.byte_size) %>
                    </p>
                  </div>
                  <svg class="w-5 h-5 #{is_sender ? 'text-white' : 'text-gray-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                  </svg>
                <% end %>
              <% end %>
            </div>
          <% end %>

          <!-- Edited indicator -->
          <% if message.edited_at.present? %>
            <p class="text-xs <%= is_sender ? 'text-teal-100' : 'text-gray-500' %> mt-2 italic flex items-center">
              <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
              Edited <%= time_ago_in_words(message.edited_at) %> ago
            </p>
          <% end %>
        </div>

        <!-- Hover actions (Edit/Delete) -->
        <% if is_sender && message.editable? %>
          <div class="absolute <%= is_sender ? 'left-0 -translate-x-full' : 'right-0 translate-x-full' %> top-0 opacity-0 group-hover/message:opacity-100 transition-opacity duration-200 flex items-center space-x-1 px-2">
            <%= button_to edit_conversation_message_path(message.conversation, message),
                  method: :get,
                  class: "p-1.5 rounded-lg bg-white hover:bg-gray-100 transition-colors duration-200 border border-gray-200",
                  form: { data: { turbo_frame: "message_#{message.id}" } },
                  title: "Edit message" do %>
              <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
            <% end %>

    <%= button_to conversation_message_path(message.conversation, message),
      method: :delete,
      data: { turbo_confirm: "Delete this message?" },
      class: "p-1.5 rounded-lg bg-white hover:bg-red-50 transition-colors duration-200 border border-gray-200",
      title: "Delete message" do %>
              <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- Message metadata (timestamp and read status) -->
      <div class="flex items-center space-x-2 mt-1 px-4">
        <p class="text-xs text-gray-500">
          <%= message.created_at.strftime("%I:%M %p") %>
        </p>

        <!-- Read status (only for sender) -->
        <% if is_sender %>
          <% if message.read? %>
            <div class="flex items-center text-xs text-teal-600">
              <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="font-medium">Read</span>
            </div>
          <% else %>
            <div class="flex items-center text-xs text-gray-400">
              <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span>Sent</span>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>

    <!-- Spacer for sent messages -->
    <% if is_sender %>
      <div class="shrink-0 w-10"></div>
    <% end %>
  </div>
</div>
