<%= form_with(model: [:admin, user], data: { controller: "admin-user-form", action: "submit->admin-user-form#handleSubmit" }, class: "space-y-8") do |form| %>
  <%# Error Summary %>
  <% if user.errors.any? %>
    <div class="rounded-xl bg-red-50 border-2 border-red-200 p-6">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div class="ml-4">
          <h3 class="text-base font-semibold text-red-800 mb-2">
            <%= pluralize(user.errors.count, "error") %> prevented this user from being saved:
          </h3>
          <div class="text-sm text-red-700">
            <ul class="list-disc pl-5 space-y-1">
              <% user.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <%# Personal Information Section %>
  <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
    <h2 class="text-lg font-bold text-gray-900 mb-6 flex items-center">
      <svg class="w-5 h-5 mr-2 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
      </svg>
      Personal Information
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <%# First Name %>
      <div>
        <%= form.label :first_name, class: "block text-sm font-medium text-gray-700 mb-2" do %>
          First Name <span class="text-red-600">*</span>
        <% end %>
        <%= form.text_field :first_name,
          required: true,
          autofocus: true,
          placeholder: "Enter first name",
          class: "block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 transition-colors #{user.errors[:first_name].any? ? 'border-red-500' : ''}" %>
        <% if user.errors[:first_name].any? %>
          <p class="mt-1 text-sm text-red-600"><%= user.errors[:first_name].first %></p>
        <% end %>
      </div>

      <%# Last Name %>
      <div>
        <%= form.label :last_name, class: "block text-sm font-medium text-gray-700 mb-2" do %>
          Last Name <span class="text-red-600">*</span>
        <% end %>
        <%= form.text_field :last_name,
          required: true,
          placeholder: "Enter last name",
          class: "block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 transition-colors #{user.errors[:last_name].any? ? 'border-red-500' : ''}" %>
        <% if user.errors[:last_name].any? %>
          <p class="mt-1 text-sm text-red-600"><%= user.errors[:last_name].first %></p>
        <% end %>
      </div>

      <%# Email %>
      <div class="md:col-span-2">
        <%= form.label :email, class: "block text-sm font-medium text-gray-700 mb-2" do %>
          Email Address <span class="text-red-600">*</span>
        <% end %>
        <%= form.email_field :email,
          required: true,
          placeholder: "user@example.com",
          class: "block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 transition-colors #{user.errors[:email].any? ? 'border-red-500' : ''}" %>
        <% if user.errors[:email].any? %>
          <p class="mt-1 text-sm text-red-600"><%= user.errors[:email].first %></p>
        <% else %>
          <p class="mt-1 text-sm text-gray-500">This will be used for login and notifications</p>
        <% end %>
      </div>

      <%# Time Zone %>
      <div class="md:col-span-2">
        <%= form.label :time_zone, class: "block text-sm font-medium text-gray-700 mb-2" do %>
          Time Zone
        <% end %>
        <%= form.time_zone_select :time_zone,
          ActiveSupport::TimeZone.us_zones,
          { default: "UTC" },
          class: "block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 transition-colors" %>
        <p class="mt-1 text-sm text-gray-500">Select the user's local time zone</p>
      </div>
    </div>
  </div>

  <%# Account Settings Section %>
  <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
    <h2 class="text-lg font-bold text-gray-900 mb-6 flex items-center">
      <svg class="w-5 h-5 mr-2 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
      </svg>
      Account Settings
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <%# Role %>
      <div class="md:col-span-2">
        <%= form.label :role, class: "block text-sm font-medium text-gray-700 mb-2" do %>
          User Role <span class="text-red-600">*</span>
        <% end %>
        <%= form.select :role,
          User.roles.keys.map { |role| [role.titleize, role] },
          {},
          required: true,
          class: "block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 transition-colors" %>
        <p class="mt-1 text-sm text-gray-500">
          <span class="font-medium">Patient:</span> Can book appointments and access services.
          <span class="font-medium">Provider:</span> Can offer services and manage appointments.
          <span class="font-medium">Admin:</span> Full system access.
        </p>
      </div>

      <%# Password (only for new users or when changing) %>
      <% if user.new_record? %>
        <%# Password %>
        <div class="md:col-span-2">
          <%= form.label :password, class: "block text-sm font-medium text-gray-700 mb-2" do %>
            Password <span class="text-red-600">*</span>
          <% end %>
          <div class="relative">
            <%= form.password_field :password,
              required: true,
              minlength: 6,
              placeholder: "Enter password (minimum 6 characters)",
              data: { admin_user_form_target: "passwordInput" },
              class: "block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 transition-colors pr-10 #{user.errors[:password].any? ? 'border-red-500' : ''}" %>
            <button type="button"
              data-action="click->admin-user-form#togglePassword"
              data-admin-user-form-target="passwordToggle"
              class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
            </button>
          </div>
          <% if user.errors[:password].any? %>
            <p class="mt-1 text-sm text-red-600"><%= user.errors[:password].first %></p>
          <% else %>
            <p class="mt-1 text-sm text-gray-500">Password must be at least 6 characters long</p>
          <% end %>
        </div>

        <%# Password Confirmation %>
        <div class="md:col-span-2">
          <%= form.label :password_confirmation, class: "block text-sm font-medium text-gray-700 mb-2" do %>
            Confirm Password <span class="text-red-600">*</span>
          <% end %>
          <div class="relative">
            <%= form.password_field :password_confirmation,
              required: true,
              placeholder: "Re-enter password",
              data: { admin_user_form_target: "passwordConfirmInput" },
              class: "block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 transition-colors pr-10 #{user.errors[:password_confirmation].any? ? 'border-red-500' : ''}" %>
            <button type="button"
              data-action="click->admin-user-form#togglePasswordConfirm"
              data-admin-user-form-target="passwordConfirmToggle"
              class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
            </button>
          </div>
          <% if user.errors[:password_confirmation].any? %>
            <p class="mt-1 text-sm text-red-600"><%= user.errors[:password_confirmation].first %></p>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <%# Avatar Upload Section %>
  <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
    <h2 class="text-lg font-bold text-gray-900 mb-6 flex items-center">
      <svg class="w-5 h-5 mr-2 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
      </svg>
      Profile Avatar <span class="text-sm font-normal text-gray-500 ml-2">(Optional)</span>
    </h2>

    <div class="flex flex-col md:flex-row gap-6">
      <%# Avatar Preview %>
      <div class="flex-shrink-0">
        <% if user.avatar.attached? %>
          <%= image_tag user.avatar,
            class: "w-32 h-32 rounded-full object-cover border-4 border-gray-200",
            alt: "Avatar preview",
            data: { admin_user_form_target: "avatarPreview" } %>
          <div class="w-32 h-32 rounded-full bg-gradient-to-br from-teal-400 to-gray-500 hidden items-center justify-center border-4 border-gray-200" data-admin-user-form-target="avatarPlaceholder">
            <svg class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
          </div>
        <% else %>
          <img data-admin-user-form-target="avatarPreview" class="w-32 h-32 rounded-full object-cover border-4 border-gray-200 hidden" alt="Avatar preview">
          <div class="w-32 h-32 rounded-full bg-gradient-to-br from-teal-400 to-gray-500 flex items-center justify-center border-4 border-gray-200" data-admin-user-form-target="avatarPlaceholder">
            <svg class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
          </div>
        <% end %>
      </div>

      <%# Upload Area %>
      <div class="flex-1">
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-teal-500 transition-colors cursor-pointer"
             data-admin-user-form-target="avatarUploadArea"
             data-action="click->admin-user-form#selectAvatar">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
          </svg>
          <p class="mt-2 text-sm text-gray-600">
            <span class="font-semibold text-teal-600">Click to upload</span> or drag and drop
          </p>
          <p class="mt-1 text-xs text-gray-500">
            PNG, JPG, GIF up to 5MB
          </p>
        </div>

        <%= form.file_field :avatar,
          accept: "image/*",
          data: {
            admin_user_form_target: "avatarInput",
            action: "change->admin-user-form#handleAvatarChange"
          },
          class: "hidden" %>

        <% if user.persisted? && user.avatar.attached? %>
          <%= form.hidden_field :remove_avatar, value: "0", data: { admin_user_form_target: "removeAvatarField" } %>
          <div class="mt-4">
            <button type="button"
              data-action="click->admin-user-form#removeAvatar"
              class="inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg transition-all duration-200">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
              Remove Avatar
            </button>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <%# Form Actions %>
  <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200">
    <div class="flex-1 flex gap-4">
      <%= form.submit user.new_record? ? "Create User" : "Update User",
        data: { admin_user_form_target: "submitButton" },
        class: "flex-1 sm:flex-none inline-flex items-center justify-center px-6 py-3 bg-gradient-to-r from-teal-600 to-gray-700 hover:from-teal-700 hover:to-gray-800 text-white font-semibold rounded-lg transition-all duration-200 shadow-md hover:shadow-lg cursor-pointer" %>

      <%= link_to "Cancel",
        user.persisted? ? admin_user_path(user) : admin_users_path,
        data: { action: "click->admin-user-form#handleCancel" },
        class: "flex-1 sm:flex-none inline-flex items-center justify-center px-6 py-3 bg-white hover:bg-gray-50 text-gray-700 font-semibold rounded-lg border-2 border-gray-300 transition-all duration-200" %>
    </div>

    <% if user.persisted? %>
      <div class="sm:ml-auto">
        <%= button_to "Delete User",
          admin_user_path(user),
          method: :delete,
          data: { confirm: "Are you sure you want to delete this user? This action cannot be undone." },
          class: "w-full sm:w-auto inline-flex items-center justify-center px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-all duration-200 shadow-md hover:shadow-lg" %>
      </div>
    <% end %>
  </div>
<% end %>
