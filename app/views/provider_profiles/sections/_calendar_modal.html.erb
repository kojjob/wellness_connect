<%
  # Fetch available slots for the next 90 days
  availabilities = provider_profile.availabilities
    .where(is_booked: false)
    .where("start_time >= ?", Time.current)
    .where("start_time <= ?", 90.days.from_now)
    .order(:start_time)

  # Format availabilities for JavaScript (Stimulus will convert to JSON)
  availabilities_data = availabilities.map do |a|
    {
      id: a.id,
      start_time: a.start_time.iso8601,
      end_time: a.end_time.iso8601,
      provider_profile_id: a.provider_profile_id
    }
  end
%>

<div data-controller="availability-calendar"
     data-availability-calendar-provider-id-value="<%= provider_profile.id %>"
     data-availability-calendar-availabilities-value='<%= availabilities_data.to_json %>'>

  <!-- Modal Backdrop and Container -->
  <div data-availability-calendar-target="modal"
       data-action="keydown.esc->availability-calendar#closeModal"
       class="hidden fixed inset-0 z-50 overflow-y-auto"
       aria-labelledby="calendar-modal-title"
       role="dialog"
       aria-modal="true">

    <!-- Backdrop -->
    <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity"
         data-action="click->availability-calendar#closeModal"></div>

    <!-- Modal Panel -->
    <div class="flex min-h-full items-center justify-center p-4">
      <div class="relative bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden"
           data-action="click->availability-calendar#stopPropagation">

        <!-- Header -->
        <div class="bg-gradient-to-r from-teal-600 to-gray-700 px-6 py-4">
          <div class="flex items-center justify-between">
            <h3 id="calendar-modal-title" class="text-xl font-bold text-white flex items-center">
              <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
              </svg>
              View All Availability
            </h3>
            <button type="button"
                    data-action="click->availability-calendar#closeModal"
                    class="text-white hover:text-gray-200 transition">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Calendar Content -->
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Calendar Grid -->
            <div>
              <!-- Month Navigation -->
              <div class="flex items-center justify-between mb-4">
                <button type="button"
                        data-action="click->availability-calendar#previousMonth"
                        class="p-2 hover:bg-gray-100 rounded-lg transition">
                  <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                  </svg>
                </button>

                <h4 data-availability-calendar-target="monthYear" class="text-lg font-semibold text-gray-900">
                  <%= Time.current.strftime("%B %Y") %>
                </h4>

                <button type="button"
                        data-action="click->availability-calendar#nextMonth"
                        class="p-2 hover:bg-gray-100 rounded-lg transition">
                  <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                  </svg>
                </button>
              </div>

              <!-- Day Headers -->
              <div class="grid grid-cols-7 gap-1 mb-2">
                <% %w[Sun Mon Tue Wed Thu Fri Sat].each do |day| %>
                  <div class="text-center text-xs font-semibold text-gray-600 py-2">
                    <%= day %>
                  </div>
                <% end %>
              </div>

              <!-- Calendar Grid (will be populated by Stimulus) -->
              <div data-availability-calendar-target="calendar" class="grid grid-cols-7 gap-1">
                <!-- JavaScript will populate this -->
              </div>
            </div>

            <!-- Time Slots Panel -->
            <div>
              <div data-availability-calendar-target="selectedDate" class="mb-4">
                <h4 class="text-lg font-semibold text-gray-900">Select a date to view available times</h4>
                <p class="text-sm text-gray-600">Click on any highlighted date on the calendar</p>
              </div>

              <div data-availability-calendar-target="timeSlots" class="space-y-2">
                <!-- Time slots will be populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
