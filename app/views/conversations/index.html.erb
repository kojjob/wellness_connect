<!-- Conversations Page -->
<div class="min-h-screen bg-gray-50">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <%# Match the Home hero styling (dark gradient + overlay), but keep it compact for app pages %>
    <section class="relative overflow-hidden rounded-3xl bg-linear-to-br from-gray-900 via-gray-800 to-indigo-900 px-6 sm:px-8 py-8 sm:py-10 shadow-2xl">
      <div class="absolute inset-0 bg-linear-to-r from-gray-900/95 via-gray-900/80 to-transparent" aria-hidden="true"></div>
      <div class="relative">
        <div class="inline-flex items-center px-4 py-2 bg-white/10 backdrop-blur-sm border border-white/20 rounded-full">
          <svg class="w-4 h-4 text-emerald-400 mr-2" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
          </svg>
          <span class="text-sm font-semibold text-white">Secure messaging</span>
        </div>

        <div class="mt-6">
          <h1 class="text-3xl sm:text-4xl font-bold text-white leading-tight">
            <span class="bg-linear-to-r from-emerald-400 via-teal-400 to-cyan-400 bg-clip-text text-transparent">Messages</span>
          </h1>
          <p class="mt-2 text-gray-300">
            <%= current_user.provider? ? "Conversations with your clients" : "Conversations with your providers" %>
          </p>
        </div>

        <%
          total_conversations = @active_conversations.size + @archived_conversations.size
          unread_count = @active_conversations.sum { |conv| conv.unread_count_for(current_user) }
        %>
        <div class="mt-6 flex flex-wrap items-center gap-3 text-sm">
          <span class="inline-flex items-center px-3 py-1.5 rounded-full bg-white/10 border border-white/20 text-white">
            Total: <span class="ml-1 font-semibold"><%= total_conversations %></span>
          </span>
          <span class="inline-flex items-center px-3 py-1.5 rounded-full bg-white/10 border border-white/20 text-white">
            Active: <span class="ml-1 font-semibold"><%= @active_conversations.size %></span>
          </span>
          <span class="inline-flex items-center px-3 py-1.5 rounded-full bg-white/10 border border-white/20 text-white">
            Unread: <span class="ml-1 font-semibold"><%= unread_count %></span>
          </span>
        </div>
      </div>
    </section>

    <%# Search %>
    <div class="mt-8 mb-6 bg-white rounded-2xl border border-gray-200 shadow-sm p-5" data-controller="search">
      <div class="flex flex-col sm:flex-row gap-4">
        <div class="flex-1">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
            </div>
                 <input type="text"
                   id="conversation-search"
                   placeholder="Search conversations…"
                   class="block w-full pl-10 pr-10 py-3 border border-gray-300 rounded-xl leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 sm:text-sm"
                   data-action="input->search#filter">
            <button type="button"
                    class="absolute inset-y-0 right-0 pr-3 flex items-center"
                    data-action="click->search#clear">
              <svg class="h-5 w-5 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <%# Active Conversations %>
    <div class="mb-12">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-900">Active</h2>
        <% if @active_conversations.any? %>
          <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-teal-50 text-teal-700 border border-teal-200">
            <%= @active_conversations.size %>
          </span>
        <% end %>
      </div>

      <% if @active_conversations.any? %>
        <div class="space-y-4" id="conversations-list">
          <% @active_conversations.each do |conversation| %>
            <%= render "conversation_item", conversation: conversation, current_user: current_user %>
          <% end %>
        </div>

        <%# Pagination %>
        <% if @active_conversations.respond_to?(:total_pages) && @active_conversations.total_pages > 1 %>
          <div class="mt-8 bg-white rounded-2xl shadow-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-600">
                Showing conversations <span class="font-semibold text-gray-900">1</span> to
                <span class="font-semibold text-gray-900"><%= @active_conversations.size %></span>
              </div>
              <div class="flex items-center space-x-2">
                <%= paginate @active_conversations %>
              </div>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="bg-white rounded-2xl border border-gray-200 p-10 text-center">
          <h3 class="text-lg font-semibold text-gray-900">No conversations yet</h3>
          <p class="mt-2 text-sm text-gray-600">
            <%= current_user.provider? ? "When clients message you, they’ll appear here." : "Browse providers and book an appointment to start messaging." %>
          </p>
          <% unless current_user.provider? %>
            <div class="mt-6">
              <%= link_to "Browse providers", providers_path,
                    class: "inline-flex items-center justify-center px-6 py-3 rounded-lg text-sm font-semibold text-white bg-emerald-500 hover:bg-emerald-600 transition-colors" %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <%# Archived Conversations %>
    <% if @archived_conversations.any? %>
      <div>
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold text-gray-900">Archived</h2>
          <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-700 border border-gray-200">
            <%= @archived_conversations.size %>
          </span>
        </div>

        <div class="space-y-4">
          <% @archived_conversations.each do |conversation| %>
            <%= render "conversation_item", conversation: conversation, current_user: current_user, archived: true %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>
