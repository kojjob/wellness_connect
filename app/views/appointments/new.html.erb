<%= turbo_frame_tag "appointment_booking" do %>
  <div class="bg-white shadow rounded-lg p-6 mt-4">
    <h3 class="text-xl font-semibold text-gray-900 mb-4">Confirm Appointment</h3>

    <div class="mb-4 p-4 bg-blue-50 rounded-lg">
      <h4 class="font-semibold text-gray-900 mb-2">Appointment Details</h4>
      <p class="text-sm text-gray-600">
        <span class="font-medium">Date:</span>
        <%= @availability.start_time.strftime("%B %d, %Y at %I:%M %p") %>
      </p>
      <p class="text-sm text-gray-600">
        <span class="font-medium">Duration:</span>
        <%= ((@availability.end_time - @availability.start_time) / 60).to_i %> minutes
      </p>
      <p class="text-sm text-gray-600">
        <span class="font-medium">Provider:</span>
        <%= @provider_profile.user.full_name %>
      </p>
    </div>

    <%= form_with(model: @appointment, url: appointments_path(availability_id: @availability.id), local: false) do |form| %>
      <div class="mb-4">
        <%= form.label :service_id, "Select Service", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= form.select :service_id,
                        options_from_collection_for_select(@services, :id, :name),
                        { prompt: "Choose a service" },
                        class: "mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" %>
      </div>

      <div id="selected-service-details" class="hidden mb-4 p-4 bg-gray-50 rounded-lg">
        <p id="service-description" class="text-sm text-gray-600 mb-2"></p>
        <p id="service-price" class="text-sm font-semibold text-blue-600"></p>
        <p id="service-duration" class="text-sm text-gray-600"></p>
      </div>

      <div class="flex justify-end space-x-3">
        <%= link_to "Cancel",
                    provider_profile_path(@provider_profile),
                    class: "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",
                    data: { turbo_frame: "_top" } %>
        <%= form.submit "Confirm Booking",
                        class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
      </div>
    <% end %>
  </div>

  <script>
    document.addEventListener('turbo:load', function() {
      const serviceSelect = document.querySelector('select[name="appointment[service_id]"]');
      const serviceDetails = document.getElementById('selected-service-details');

      if (serviceSelect) {
        // Get service data from select options
        const services = <%= raw @services.to_json(only: [:id, :name, :description, :price, :duration_minutes]) %>;

        serviceSelect.addEventListener('change', function() {
          const selectedServiceId = this.value;
          const service = services.find(s => s.id == selectedServiceId);

          if (service) {
            document.getElementById('service-description').textContent = service.description;
            document.getElementById('service-price').textContent = `$${parseFloat(service.price).toFixed(2)}`;
            document.getElementById('service-duration').textContent = `Duration: ${service.duration_minutes} minutes`;
            serviceDetails.classList.remove('hidden');
          } else {
            serviceDetails.classList.add('hidden');
          }
        });
      }
    });
  </script>
<% end %>
